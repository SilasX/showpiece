<!DOCTYPE html>
<html id="home" lang="en">
  <head>
    <meta charset=utf-8 />
    <title>Showpiece Playground</title>
    <script src="json-template.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>

    <style>
      .tl, .tr, .bl, .br {
        position: absolute;
      }
      .tl { top: 0; left: 0; right: 50%; bottom: 50%; }
      .tr { top: 0; left: 50%; right: 0; bottom: 50%; }
      .bl { top: 50%; left: 0; right: 50%; bottom: 0; }
      .br { top: 50%; left: 50%; right: 0; bottom: 0; }

      .liner { position: relative; width: 100%; height: 100%; }

      .controls {
        position: absolute;
        top: 0;
        height: 25px;
      }

      textarea {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        -ms-box-sizing: border-box;
        box-sizing: border-box;
        height:98%;
        width: 99%;
      }
      #editor, #css {
        padding-top: 25px;
      }
    </style>

    <style class="github"></style>
  </head>
  <body>
    <div class="tl"><div class="liner">
      <div class="controls">
        <select id="widgets"></select>
        <select id="examples"></select>
        <button id="render">Render</button>
      </div>
      <textarea id="editor"></textarea>
    </div></div>
    <div class="bl"><div class="liner">
      <textarea id="template"></textarea>
    </div></div>
    <div class="tr"><div class="liner">
      <div id="preview"></div>
    </div></div>
    <div class="br"><div class="liner">
      <div class="controls">
        <select id="styles"></select>
        <button id="apply">Apply</button>
      </div>
      <textarea id="css"></textarea>
    </div></div>

    <script>
      $(function () {
        $('#examples').change(function () {
          $.ajax({
            url: this.value,
            dataType: 'json',
            success: function (data) {
              $('#editor').val(window.atob(data.content.replace(/\s/g, '')));
            }
          });
        });
        $('#styles').change(function () {
          $.ajax({
            url: this.value,
            dataType: 'json',
            success: function (data) {
              $('#css').val(window.atob(data.content.replace(/\s/g, '')));
            }
          });
        });

        $('#widgets').change(function () {
          $('#examples').empty();
          var widget = this.value;
          $.ajax({
            url: 'https://api.github.com/repos/begriffs/showpiece/contents/' + widget + '/examples',
            dataType: 'json',
            success: function (data) {
              _.each(data, function (file) {
                $('#examples').append(
                  $('<option></option>')
                    .attr('value', file.url)
                    .text(file.name)
                );
              });
              $('#examples').trigger('change');

              $.ajax({
                url: 'https://api.github.com/repos/begriffs/showpiece/contents/' + widget + '/template?ref=master',
                dataType: 'json',
                success: function (data) {
                  $('#template').val(window.atob(data.content.replace(/\s/g, '')));
                }
              });
            }
          });

          $.ajax({
            url: 'https://api.github.com/repos/begriffs/showpiece/contents/' + widget + '/styles',
            dataType: 'json',
            success: function (data) {
              _.each(data, function (file) {
                $('#styles').append(
                  $('<option></option>')
                    .attr('value', file.url)
                    .text(file.name)
                );
              });
              $('#styles').trigger('change');
            }
          });
        });

        $.ajax({
          url: 'https://api.github.com/repos/begriffs/showpiece/contents/',
          dataType: 'json',
          success: function (data) {
            _.each(data, function (file) {
              if(file.type === 'dir') {
                $('#widgets').append(
                  $('<option></option>')
                    .attr('value', file.path)
                    .text(file.name)
                );
              }
            });
            $('#widgets').trigger('change');
          }
        });

        $('#render').click(function () {
          $('#preview').html(
            jsontemplate.expand(
              $('#template').val(),
              JSON.parse($('#editor').val())
            )
          );
        });

        $('#apply').click(function () {
          $('style.github').html($('#css').val());
        });
      });
    </script>
  </body>
</html>
